name: Pre-Release

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled

jobs:
    deploy:

      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v2

        - name: Fetch history
          run: git fetch --prune --unshallow

        - name: Configure Git
          run: |
            git config user.name "$GITHUB_ACTOR"
            git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

        - name: Install Helm
          run: |
            curl -fsSLo get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
            chmod 700 get_helm.sh
            ./get_helm.sh

        # prepare yaml parser
        - uses: actions/setup-go@v4
        - name: Install yq
          run: |
            go install github.com/mikefarah/yq/v4@latest
            yq --version

        - name: Set the version
          run: |
            find ./charts -type d -maxdepth 1 -mindepth 1
            charts=$(find ./charts -type d -maxdepth 1 -mindepth 1)
            for c in "${charts[@]}"; do
              version=$(yq e '.version' "charts/$c/Chart.yaml")
              yq e -i '.version = "'$version'-PRE"' charts/$c/Chart.yaml
            done 

        - name: Run chart-releaser
          uses: helm/chart-releaser-action@v1.6.0
          env:
            CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
            CR_SKIP_EXISTING: true
          with:
            pages_branch: chart-prereleases